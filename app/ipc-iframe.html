<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parameter1 SSO iFrame Test</title>


  </head>
  <body>
    <h1>Some P1 App</h1>
    <script type="module">
      ((origin) => {
        const parse = (json) => {
        try {
          return JSON.parse(json);
        } catch (e) {
          return null;
        }
      };

      window.addEventListener('message', (event) => {
        if (event.origin !== origin) return;
        const message = parse(event.data);
        if (!message || message.cat !== 'p1-sso-token') return;
        const { act } = message;

        if (act === 'add') {
          window.location.reload();
          return;
        }

        if (act === 'remove') {
          const next = 'https://manage.allured.com';
          const href = `${origin}/app/login?next=${encodeURIComponent(next)}`;
          window.location.href = href;
        }
      }, false);

      const iframe = document.createElement('iframe');
      iframe.src = `${origin}/app/_ipc`;
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      })('http://sso.dev.parameter1.com:7913');
    </script>
  </body>
</html>
